<script>
    let total_time = 6;
    let start_time = 0;
    let target_time = 2;
    let reaction_time = null;
    let game_active = false;
    let countdown_interval = null;
    let remaining_seconds = total_time;
    let restartButton = null;
    let numberOfPeriods = 1;

    function getNumberOfPeriods() {
        numberOfPeriods = prompt("Choose the number of periods (positive integer):");
        numberOfPeriods = parseInt(numberOfPeriods);

        while (isNaN(numberOfPeriods) || numberOfPeriods <= 0 || !Number.isInteger(numberOfPeriods)) {
            numberOfPeriods = prompt("Invalid input. Please enter a positive integer for the number of periods:");
            numberOfPeriods = parseInt(numberOfPeriods);
        }

        // Calculate target_time as a random time between (T-3)/T and (T-2)/T of total time
        const lower_bound = total_time * (numberOfPeriods - 3) / numberOfPeriods;
        const upper_bound = total_time * (numberOfPeriods - 2) / numberOfPeriods;
        target_time = lower_bound + Math.random() * (upper_bound - lower_bound);

        document.getElementById('period-info').textContent = `Number of periods: ${numberOfPeriods}`;
        document.getElementById('period-length').textContent = `Length of a period: ${(total_time / numberOfPeriods).toFixed(3)} seconds`;
        document.getElementById('stop-info').textContent = `Stop the game between period ${numberOfPeriods - 3} and ${numberOfPeriods - 2}`;
        updateDisplay();
    }

    window.onload = getNumberOfPeriods;

    function updateDisplay() {
        document.getElementById('target-time').textContent = `Target Time: between ${(target_time - (total_time / numberOfPeriods)).toFixed(3)} and ${target_time.toFixed(3)} seconds`;
        document.getElementById('remaining-time').textContent = `Time Remaining: ${remaining_seconds.toFixed(1)} seconds`;
        document.getElementById('start-button').textContent = `Press Me!`;
        document.getElementById('start-button').onclick = onPress;
    }

    function startCountdown() {
        countdown_interval = setInterval(function () {
            remaining_seconds -= 0.1;
            document.getElementById('remaining-time').textContent = `Time Remaining: ${remaining_seconds.toFixed(1)} seconds`;

            if (remaining_seconds <= 0) {
                clearInterval(countdown_interval);
                updateResult();
                showRestartButton();
            }
        }, 100);
    }

    function startGame() {
        if (restartButton) {
            restartButton.style.display = 'none';
        }

        start_time = new Date().getTime();
        reaction_time = null;
        game_active = true;
        remaining_seconds = total_time;

        updateDisplay();
        startCountdown();
    }

    function onPress() {
        if (game_active && reaction_time === null) {
            let currentTime = new Date().getTime();
            reaction_time = currentTime - start_time;
            let remainingTimeAtClick = remaining_seconds;
            let lapse = total_time / numberOfPeriods;
            let hittingtime = remainingTimeAtClick.toFixed(1);

            let feedback = "";
            if (hittingtime >= target_time && hittingtime <= (target_time + lapse)) {
                feedback = "On time";
            } else if (hittingtime > (target_time - 2 * lapse) && hittingtime <= (target_time - 1 * lapse)) {
                feedback = "2 periods too late";
            } else if (hittingtime < (target_time - 2 * lapse)) {
                feedback = "way too late";
            } else if (hittingtime > (target_time - lapse) && hittingtime <= (target_time)) {
                feedback = "1 period too late";
            } else if (hittingtime > (target_time + lapse) && hittingtime <= (target_time + 2 * lapse)) {
                feedback = "1 period too early";
            } else if (hittingtime > (target_time + 2 * lapse) && hittingtime <= (target_time + 3 * lapse)) {
                feedback = "2 periods too early";
            } else if (hittingtime > (target_time + 3 * lapse) && hittingtime <= (target_time + 4 * lapse)) {
                feedback = "3 periods too early";
            } else {
                feedback = "Way too early";
            }

            document.getElementById('remaining-time').textContent = `Period you clicked: ${feedback}. Remaining time at click: ${remainingTimeAtClick.toFixed(1)} seconds.`;

            game_active = false;
            clearInterval(countdown_interval);
            showRestartButton();
        }
    }

    function updateResult() {
        game_active = false;
    }

    function showRestartButton() {
        if (!restartButton) {
            restartButton = document.createElement('button');
            restartButton.textContent = 'Restart';
            restartButton.onclick = startGame;
            restartButton.classList.add('restart-button');
            document.getElementById('game-container').appendChild(restartButton);
        } else {
            restartButton.style.display = 'block';
        }
    }
</script>
